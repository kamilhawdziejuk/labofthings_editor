<script type="text/javascript" src="../GuiWeb/homeos-1.1.js"></script>
<!DOCTYPE html>
<html>

<head>
  <title>Lights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
   <script type="text/javascript" src="../GuiWeb/jquery-1.7.1.js"></script>
  <script type="text/javascript" src="../GuiWeb/common.js"></script>
  <link rel="Stylesheet" type="text/css" href="Styles/AppLightsStyleSheet.css" />
 
    <script>

        //array of switchs, each switch has 4 elements: name::zwavetype, location, type (multi, binary), value
        var SWITCH_INFORMATION_ARRAY = new Array();

        
        $(document).ready(
            function () {
              new PlatformServiceHelper().MakeServiceCall("webapp/GetAllSwitches", "", GetSwitchesCallback);
            }
        );

        function switchObject(sName, locationAtHome, sType, sValue) {
            var switchO = new Object();
            switchO.switchName = sName;
            switchO.switchLocation = locationAtHome;
            switchO.switchType = sType;
            switchO.switchValue = sValue;
            return switchO;
        }

        function GetSwitchesCallback(context, result) {
           
            SWITCH_INFORMATION_ARRAY = new Array();  //delete the old one

            //create switch objects and add them to the SWITCH_INFORMATION_ARRAY
            if (result[0] == "") {
                for (j = 1; j + 3 < result.length; j = j + 4) {                  
                 var newSwitch = switchObject(result[j], result[j + 1], result[j + 2], result[j + 3]);
                 SWITCH_INFORMATION_ARRAY.push(newSwitch);
                }

                CreateUI();
            }
            else {
                DisplayDebugging("GetSwitchesCallback:" + result[0]);
            }
        }

        function CreateUI() {
            $("#lights").html("");

            var handledLocations = new Array();

            //We want to show the lights grouped by location - for each light, check if it's location has already been handled, 
            for (i = 0; i < SWITCH_INFORMATION_ARRAY.length; i++) {

                if (jQuery.inArray(SWITCH_INFORMATION_ARRAY[i].switchLocation, handledLocations) == -1) {
                    //this location hasn't been handled so we need to create a new header, add this switch and look for any others with this location
                    var currentLocation = SWITCH_INFORMATION_ARRAY[i].switchLocation;
                    //add header
                    $("#lights").append('<div class="row"> <div class="related_content col" >' + currentLocation + '</div></div>');

                    //add this switch andd through the rest of array looking for others in this location
                    for (j = i; j < SWITCH_INFORMATION_ARRAY.length; j++) {
                        if (SWITCH_INFORMATION_ARRAY[j].switchLocation == currentLocation) {
                            //add this switch
                            $("#lights").append('<div class="app_content col">' + SwitchSimpleName(SWITCH_INFORMATION_ARRAY[j].switchName) + " is " + isOnorOff(SWITCH_INFORMATION_ARRAY[j].switchValue) + '     <button class= "app_button" onclick="SingleSwitch(' + "'" + SWITCH_INFORMATION_ARRAY[j].switchName + "','1'" + ')"  >On </button>' + '      <button class= "app_button" onclick="SingleSwitch(' + "'" + SWITCH_INFORMATION_ARRAY[j].switchName + "','0'" + ')"  >Off </button> </div>');
                        }
                    }
                    //we have now handled location.
                    handledLocations.push(currentLocation);

                }
            }

        }

        function AllLights(level) {
            //For each switch in the SWITCH INFORMAION ARRAY we are going to set the value to 0
            for (i = 0; i < SWITCH_INFORMATION_ARRAY.length; i++) {
                //calling SetLevel(string switchFriendlyName, string level);
                new PlatformServiceHelper().MakeServiceCall("webapp/SetLevel", '{"switchFriendlyName": "' + SWITCH_INFORMATION_ARRAY[i].switchName + '","level":"' + level +'"}', SetLevelCallback);
            }
        }

        function SingleSwitch(switchName, level) {
            new PlatformServiceHelper().MakeServiceCall("webapp/SetLevel", '{"switchFriendlyName": "' + switchName + '","level":"' + level +'"}', SetLevelCallback);
        }

        function SetLevelCallback(context, result) {         
            if (result[0] == "") {
                //Switch the UI to reflect the current level -- TODO just ask for the level of the current switch
               new PlatformServiceHelper().MakeServiceCall("webapp/GetAllSwitches", "", GetSwitchesCallback);
            }
            else {
                DisplayDebugging("SetLevelCallback:" + result[0]);
            }
        }

  

        function SwitchSimpleName(nameWithType) {
            var nameWithoutType = nameWithType.split("::");
            return nameWithoutType[0];
        }

        function isOnorOff(currentLevel) {
            var currState = "Off";
            if (currentLevel != 0) {
                currState = "On";
            }
            return currState;
        }

      
    </script>
</head>
<body>
        <div class="dashboard_toolbar">
            <div class="homeID_title"><a href="../GuiWeb/index.html">Dashboard</a> | Lights </div>
        </div>
        
        <div class="page">
            <div class="row">
                <div class="page_title col">Lights</div>
            </div>
            <div class="row">
                <div id="allOffButton" class="app_content col">
                    <button id="btnAllOff" class="app_button" onclick="AllLights(0)">
                        All Off
                    </button>
                         <button id="btnAllOn" class="app_button" onclick="AllLights(1)">
                        All On
                    </button>
                </div>
            </div>
            <div class="row">
                
            </div>
            <div class="row" id="lights" >
                <div class="app_content col"> Test:0 <button class= "app_button" onclick="SingleSwitch('Test','1')"  >On </button>      <button class= "app_button" onclick="SingleSwitch('Test','0')"  >Off </button> </div>
            
            </div>

   

        <!--Used for debugging messages, set style="display:none" to turn off showing them, common.js will put text into div with id =divDebugInfo when calls are made to service -->
       <div id="divDebugInfo" style="display:none"></div>
    </div>
    
</body>
</html>
